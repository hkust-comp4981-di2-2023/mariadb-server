--source include/have_sequence.inc
--source include/have_innodb.inc
--source include/big_test.inc
--source include/not_valgrind.inc
#
# Test tmp_space_usage
#

--echo #
--echo # MDEV-9101 Limit size of total size of created disk temporary files
--echo #           and tables.

# Print variables that can affect the test result
show session status like "tmp_space_used";
show global status like "tmp_space_used";
select @@global.max_tmp_space_usage, @@global.max_total_tmp_space_usage;
select @@binlog_stmt_cache_size,@@binlog_format;

create table t1 (a int primary key, v varchar(256), c int default(0)) engine=innodb;
--error 41
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_65536;
set @@max_tmp_space_usage=1024*1024*1024;
--error 42
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_65536;
set @@max_tmp_space_usage=default;

set @@binlog_format="statement";
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_65536;
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_65537_to_131072;
select count(*) from t1;

create table t2 (a int, b int) engine=innodb select seq as a, 0 as b from seq_1_to_131072;

# Force usage of on disk tmp tables
set @@binlog_format="row";
set @@tmp_memory_table_size=32*1024;

--echo # The following queries should fail because of tmp_space_usage
--error 41
select * from t1 order by a,v;
--error 200
select v,count(*) from t1 group by v limit 2;
--error 41
update t1 set v=right(v,2);

set @@binlog_format="statement";
set @@max_tmp_space_usage=65536;
set @@tmp_memory_table_size=0;
--error 200
update t1,t2 set t1.c=t2.a, t2.b=1 where t1.a=t2.a;
set @@binlog_format="row";
set @@max_tmp_space_usage=default;

drop table t1,t2;

--echo #
--echo # Check max_total_tmp_space_usage & processlist
--echo #

show session status like "tmp_space_used";
show global status like "tmp_space_used";
let $tmp_usage1=`select variable_value from information_schema.session_status where variable_name="max_tmp_space_used"`;
flush status;
let $tmp_usage2=`select variable_value from information_schema.global_status where variable_name="max_tmp_space_used"`;

--disable_query_log
if ($tmp_usage1 == $tmp_usage2)
{
--echo # session.max_tmp_space_usage == global.max_tmp_space_usage
}
if ($tmp_usage1 != $tmp_usage2)
{
--echo session.max_tmp_space_usage != global.max_tmp_space_usage
}
--enable_query_log


connect(c1, localhost, root,,);
connection default;

create table t1 (a int primary key, v varchar(256), c int default(0)) engine=innodb;
create table t2 (a int primary key, v varchar(256), c int default(0)) engine=innodb;

begin;
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_3000;

let $id=`select connection_id()`;
let $tmp_usage1=`select variable_value from information_schema.session_status where variable_name="tmp_space_used"`;

connection c1;
--disable_query_log
let $tmp_usage2=`select tmp_space_used from information_schema.processlist where id=$id`;
if ($tmp_usage1 == $tmp_usage2)
{
--echo # information_schema.process_list.tmp_space_used == status.tmp_space_used
}
if ($tmp_usage1 != $tmp_usage2)
{
--echo tmp_space_used difference: $tmp_usage1 != $tmp_usage2
}
--enable_query_log

--error 42
insert into t2 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_3000;
--echo # Test setting tmp_space_usage to 0 to disable quotas
set @@global.max_total_tmp_space_usage=0;
set @@max_tmp_space_usage=0;
insert into t2 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_3000;
set @@global.max_total_tmp_space_usage=default;
set @@max_tmp_space_usage=0;
connection default;
insert into t1 (a,v) values(9999990,0);
commit;
select count(*) from t1;

disconnect c1;
drop table t1,t2;
